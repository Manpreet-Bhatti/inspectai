// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  name           String?
  passwordHash   String?
  role           Role          @default(INSPECTOR)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  inspections    Inspection[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  users     User[]
  createdAt DateTime @default(now())
}

enum Role {
  INSPECTOR
  MANAGER
  ADMIN
}

model Inspection {
  id           String           @id @default(cuid())
  title        String
  address      String
  city         String
  state        String
  zipCode      String
  propertyType PropertyType
  status       InspectionStatus @default(DRAFT)
  userId       String
  user         User             @relation(fields: [userId], references: [id])
  photos       Photo[]
  voiceNotes   VoiceNote[]
  findings     Finding[]
  reports      Report[]
  scheduledAt  DateTime?
  completedAt  DateTime?
  metadata     Json?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([userId, status])
  @@index([createdAt(sort: Desc)])
}

enum PropertyType {
  SINGLE_FAMILY
  MULTI_FAMILY
  CONDO
  TOWNHOUSE
  COMMERCIAL
  INDUSTRIAL
}

enum InspectionStatus {
  DRAFT
  IN_PROGRESS
  REVIEW
  COMPLETED
  ARCHIVED
}

model Photo {
  id           String        @id @default(cuid())
  inspectionId String
  inspection   Inspection    @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  fileName     String
  originalUrl  String
  thumbnailUrl String?
  category     PhotoCategory
  location     String?
  width        Int?
  height       Int?
  aiCaption    String?
  aiObjects    Json?
  aiCondition  String?
  aiConfidence Float?
  processedAt  DateTime?
  error        String?
  findings     Finding[]
  createdAt    DateTime      @default(now())

  @@index([inspectionId])
}

enum PhotoCategory {
  EXTERIOR
  INTERIOR
  ROOF
  FOUNDATION
  ELECTRICAL
  PLUMBING
  HVAC
  STRUCTURAL
  OTHER
}

model VoiceNote {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  audioUrl     String
  duration     Int
  transcript   String?
  summary      String?
  processedAt  DateTime?
  error        String?
  findings     Finding[]
  createdAt    DateTime   @default(now())

  @@index([inspectionId])
}

model Finding {
  id            String          @id @default(cuid())
  inspectionId  String
  inspection    Inspection      @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  photoId       String?
  photo         Photo?          @relation(fields: [photoId], references: [id])
  voiceNoteId   String?
  voiceNote     VoiceNote?      @relation(fields: [voiceNoteId], references: [id])
  title         String
  description   String
  category      FindingCategory
  severity      Severity
  location      String?
  costEstimate  Float?
  costMin       Float?
  costMax       Float?
  status        FindingStatus   @default(ACTIVE)
  isAiGenerated Boolean         @default(false)
  confidence    Float?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([inspectionId])
  @@index([severity])
}

enum FindingCategory {
  STRUCTURAL
  ELECTRICAL
  PLUMBING
  HVAC
  ROOFING
  EXTERIOR
  INTERIOR
  APPLIANCES
  SAFETY
  COSMETIC
}

enum Severity {
  CRITICAL
  MAJOR
  MINOR
  COSMETIC
  INFO
}

enum FindingStatus {
  ACTIVE
  RESOLVED
  DISPUTED
}

model Report {
  id           String     @id @default(cuid())
  inspectionId String
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  type         ReportType
  fileUrl      String?
  summary      String?
  totalCost    Float?
  generatedAt  DateTime   @default(now())

  @@index([inspectionId])
}

enum ReportType {
  FULL
  SUMMARY
  DEFECTS
}
